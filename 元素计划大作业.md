# 七、后端实现 [王奕婷]

## 7.1 技术栈与架构

本项目后端采用 **Python + Django 框架** 进行开发。Django 是一个高效、全能的 Web 开发框架，具有如下优势：

- **集成度高**：自带 ORM，无需手写SQL，通过Python类定义数据库模型，提供丰富的查询API，自动生成数据库迁移脚本；提供了完整的用户系统,支持自定义用户模型拓展；提供管理后台功能模块，适合快速构建应用；
- **社区活跃**：大量第三方库和良好文档支持；
- **安全性强**：内建多种安全防护机制，如 CSRF、SQL 注入预防等。

整体架构为 **前后端分离架构**，后端以 RESTful API 形式对外提供服务，前端通过 HTTP 请求调用。

# 7.2 核心业务模块实现

## 7.2.1 用户注册与邮箱验证码校验

用户注册通过 `/register/` 接口完成，支持 GET 和 POST 请求。  
POST 请求流程包括：

- 用户提交邮箱、用户名、密码和验证码；
- 从 Redis 获取缓存的验证码，判断验证码有效性；
- 验证通过后，创建 `User` 和关联的 `UserProfile`；
- 注册成功后清除验证码缓存，避免重复使用。

邮箱验证码通过 `/send_email_captcha/` 接口发送：

- 限制 60 秒内只能发送一次；
- 生成 4 位随机数字验证码；
- 使用 Django 内置的 `send_mail` 函数发送邮件；
- 验证码存储在 Redis，5 分钟内有效。

---

## 7.2.2 用户登录与会话管理

登录接口 `/login/` 支持邮箱和密码登录：

- 验证用户邮箱和密码是否正确；
- 登录成功后调用 Django `login()` 记录会话；
- 设置 Redis 缓存键 `is_logged_in:{user.id}` 和 `login_time:{user.id}`；
- “记住我”未选中时，Session 关闭浏览器即失效；
- 返回 JSON 格式的登录状态和消息。

退出接口 `/logout/`：

- 清除登录状态缓存；
- 调用 Django `logout()` 注销当前用户；
- 返回成功登出提示。

---

## 7.2.3 用户信息获取与更新

用户信息查看接口 `/get_user_info/`：

- 用户登录后可获取其 `UserProfile` 信息；
- 优先从 Redis 缓存读取，缓存不存在则查询数据库；
- 缓存数据有效期 5 分钟。

用户信息更新接口 `/update_user_info/`：

- 支持修改用户名、邮箱、密码、职业、出生日期等；
- 同步更新 `User` 和 `UserProfile` 两个模型；
- 更新成功后清除缓存，确保下次读取最新数据；
- 对于未填写的字段保持原值不变。

---

## 7.2.4 用户文件上传与下载

文件上传接口 `/upload_file/`：

- 支持用户上传文件；
- 如已存在文件，先删除旧文件再保存新文件；
- 记录上传时间。

文件下载接口 `/download_file/`：

- 用户下载自己的文件；
- 使用流式响应发送文件内容；
- 设置响应头实现附件下载；
- 非文件所有者尝试下载时抛出权限异常。


## 7.3 中间件与工具集成

在本项目中，采用了Django框架，利用其丰富的中间件和工具集成能力，保障系统的安全性、性能和功能扩展。

### 7.3.1 数据库中间件

数据库中间件主要用于管理数据库连接和事务，Django ORM本身封装了大量数据库操作，提升开发效率与安全性。通过中间件保证请求过程中的数据库连接稳定，自动处理事务提交和回滚。

> **示例**  
> Django默认配置下，数据库操作通过ORM完成，以下示例展示了通过ORM安全获取用户文件记录：
> ```python
> from django.shortcuts import get_object_or_404
> user_file = get_object_or_404(UserFile, user_id=request.user.id)
> ```
> 该方式确保在数据库中查找对应用户文件，如无数据则抛出404异常。

### 7.3.2 缓存机制（Redis）

为提高系统性能，使用Redis作为缓存服务器。缓存机制减轻数据库压力，快速响应频繁请求。可缓存登录状态、验证码等信息。

> **示例代码：**
> ```python
> from django.core.cache import cache
> cache.set('user_123_session', 'session_data', timeout=3600)
> session = cache.get('user_123_session')
> ```


### 7.3.3 日志系统

日志系统用于记录系统运行状态，方便调试与故障排查。通过Django内置日志配置(setting.py文件中设置)，实现多级日志管理和文件持久化。


---


# 十、系统测试 [龚嘉瑶、李四、王五]

## 10.1 测试策略与计划

### 自动化测试方案

**测试金字塔策略：**

- 底层：单元测试（60%）

- 中层：集成测试（30%）

- 顶层：端到端测试（10%）

**自动化测试工具链：**

- Flutter SDK 内置测试框架 (`test`, `flutter_test`)
- Mockito：模拟依赖
- integration_test：集成测试
- GitHub Actions：CI/CD 流水线
- Codemagic：移动端专用 CI
- Appium：跨平台 UI 自动化
- Lighthouse：性能测试

**测试计划时间表：**

| 阶段     | 时间点       | 主要活动              | 自动化覆盖率 |
| :------- | :----------- | :-------------------- | :----------- |
| 开发阶段 | 功能开发期间 | 单元测试 + 组件测试   | 70%          |
| 提测前   | 功能完成时   | 模块集成测试          | 85%          |
| 预发布   | 发布候选版   | 端到端测试 + 性能测试 | 95%          |
| 生产环境 | 发布后       | 监控 + 异常测试       | -            |

## 10.2 单元测试

### 测试方案与覆盖统计

**测试策略：**

- 纯函数：100% 覆盖
- 业务逻辑：边界值+异常路径覆盖
- Widget：状态变化测试

**前端单元测试统计：**

| 模块     | 测试用例数 | 覆盖率  | 关键测试点              |
| :------- | :--------- | :------ | :---------------------- |
| 用户认证 | 11         | 95%     | 登录/注册/令牌刷新      |
| 计划管理 | 42         | 92%     | 创建/修改计划/日期切换  |
| 代办管理 | 31         | 90%     | 创建/修改代办/分类      |
| 数据同步 | 26         | 85%     | 冲突解决/离线处理       |
| 图像处理 | 19         | 80%     | 压缩/水印/OCR           |
| 计时器   | 11         | 93%     | 开始/暂停/停止/插入图片 |
| **总计** | **181**    | **89%** | -                       |

**后端单元测试细则：**

| 测试名称                                | 测试内容             | 所在文件            | 涉及字段/函数                         
| ----------------------------------- | ---------------- | --------------- | --------------------------------- | 
| `test_valid_register_form`          | 正确注册数据表单是否通过验证   | `test_forms.py` | `RegisterForm.is_valid()`         |
| `test_username_too_short`           | 用户名过短是否报错        | `test_forms.py` | `username` 字段                     | 
| `test_email_invalid_format`         | 邮箱格式非法是否报错       | `test_forms.py` | `email` 字段格式校验                    |
| `test_email_already_registered`     | 邮箱重复是否报错         | `test_forms.py` | `clean_email()`                   |
| `test_wrong_captcha`                | 验证码错误是否拦截        | `test_forms.py` | `clean_captcha()`                 |
| `test_expired_captcha`              | 验证码过期是否提示        | `test_forms.py` | `cache.get()` & `clean_captcha()` |
| `test_valid_login_form`             | 登录表单基础校验         | `test_forms.py` | `LoginForm.is_valid()`            |
| `test_login_form_no_remember`       | 登录表单可不传 remember | `test_forms.py` | `remember` 字段                     |
| `test_invalid_email_format (login)` | 登录时邮箱格式校验        | `test_forms.py` | `email` 字段格式                      |
| `test_password_too_short (login)`   | 登录时密码过短          | `test_forms.py` | `password` 字段                     |



| 测试方法名                                   | 测试功能简述                             | 涉及视图名（或URL别名）                            | 请求类型       | 涉及模块   |
| --------------------------------------- | ---------------------------------- | ---------------------------------------- | ---------- | ------ |
| `test_register_get`                     | 用户注册页面 GET 请求是否返回成功及正确提示         | `user:register`                          | `GET`      | 注册视图   |
| `test_register_post_invalid_form`       | 无效表单注册请求是否返回 400 错误              | `user:register`                          | `POST`     | 注册视图   |
| `test_register_post_valid_with_captcha` | 正确验证码和数据时注册成功，并创建用户              | `user:register`                          | `POST`     | 注册视图   |
| `test_send_email_captcha`               | 发送邮箱验证码：第一次成功，第二次请求频繁失败（状态码 429） | `user:send_email_captcha`                | `GET`      | 邮件发送   |
| `test_login_get`                        | 登录页面 GET 请求是否成功及返回正确提示           | `user:login_view`                        | `GET`      | 登录视图   |
| `test_login_post_success_and_fail`      | 登录成功和失败的处理逻辑                     | `user:login_view`                        | `POST`     | 登录视图   |
| `test_logout_view`                      | 登出接口功能是否正常                       | `user:logout_view`                       | `GET`      | 登出视图   |
| `test_get_user_info_cache_and_db`       | 用户信息获取接口，首次访问从数据库，二次访问从缓存获取      | `user:get_user_info`                     | `GET`      | 用户信息   |
| `test_update_user_info`                 | 更新用户信息功能是否成功，包含密码和个人信息更新         | `user:update_user_info`                  | `POST`     | 用户信息更新 |
| `test_upload_file_and_download_file`    | 文件上传与下载功能是否正常                    | `user:upload_file`, `user:download_file` | `POST/GET` | 文件管理   |

| 测试类名                   | 测试方法名                       | 测试目标/功能                            | 覆盖模型           |
| ---------------------- | --------------------------- | ---------------------------------- | -------------- | 
| `UserProfileModelTest` | `test_userprofile_creation` | 测试 `UserProfile` 创建时字段是否正确         | `UserProfile`  | 
|                        | `test_userprofile_str`      | 测试 `__str__` 方法是否返回用户名             | `UserProfile`  | 
| `UserFileModelTest`    | `test_userfile_creation`    | 测试 `UserFile` 创建时用户和上传文件是否正确       | `UserFile`     | 
| `CaptchaModelTest`     | `test_captcha_creation`     | 测试 `CaptchaModel` 创建时邮箱、验证码及时间是否正确 | `CaptchaModel` | 

**后端单元测试汇总：**

| 模块          | 测试用例数 | 代码覆盖率 | 关键测试点                                                                       |
| ----------- | ----- | ----- | --------------------------------------------------------------------------- |
| `models.py` | 2     | 65%   | - 用户扩展模型 `UserProfile` 创建测试<br>- 用户文件模型 `UserFile` 创建与属性验证（如路径、文件名）         |
| `views.py`  | 10    | 82%   | - 注册（GET/POST）<br>- 登录（成功/失败）<br>- 发送验证码频控<br>- 用户信息获取与更新（含缓存）<br>- 文件上传与下载 |
| `forms.py`  | 3     | 74%   | - 注册表单字段校验<br>- 登录表单有效性测试<br>- 表单字段为空/格式错误测试                                |








## 10.3 集成测试

**测试策略：**

- 契约测试：验证 API 响应结构
- 状态验证：数据库状态一致性
- 认证流程：令牌生命周期测试
根据你提供的 Django 视图代码，如果前端分别请求每个视图函数，将返回如下这些结果：

---

###  `register(request)`

* **路径假设为** `/register/`

#### GET 请求：

```json
{"message": "GET register.html"}
```

#### POST 请求（表单验证通过 + 验证码正确）：

```json
{"code": 200, "message": "注册成功"}
```

#### POST 请求失败的几种情况：

1. **验证码过期或未设置：**

   ```json
   {"code": 400, "message": "验证码已过期，请重新获取"}
   ```

2. **验证码错误：**

   ```json
   {"code": 400, "message": "验证码错误"}
   ```

3. **表单验证失败：**

   ```json
   {
     "code": 400,
     "message": "表单验证失败",
     "errors": {"字段名": ["错误描述"]}
   }
   ```

---

###  `send_email_captcha(request)`

* **路径假设为** `/send_email_captcha/?email=xxx`

#### 没有传 email：

```json
{"error": "Email field is empty."}
```

#### 60 秒内重复请求：

```json
{"code": 429, "message": "请勿频繁请求验证码（60秒内）"}
```

#### 发送成功：

```json
{"code": 200, "message": "邮箱验证码发送成功！"}
```

---

###  `login_view(request)`

* **路径假设为** `/login/`

#### GET 请求：

```json
{"message": "GET login.html", "status": "ready"}
```

#### POST 请求结果：

1. **成功登录：**

   ```json
   {
     "message": "登录成功",
     "status": "success",
     "user_id": 用户ID
   }
   ```

2. **账号密码错误：**

   ```json
   {
     "message": "邮箱或密码错误",
     "status": "invalid_credentials"
   }
   ```

3. **表单验证失败：**

   ```json
   {
     "message": "form is invalid",
     "errors": {
       "字段名": [{"message": "错误信息"}]
     }
   }
   ```

---

###  `logout_view(request)`

* **路径假设为** `/logout/`
* 返回：

```json
{"code": 200, "message": "已退出登录"}
```

---

###  `get_user_info(request)`（需登录）

* **路径假设为** `/get_user_info/`

1. **缓存命中：**

   ```json
   {
     "code": 200,
     "message": "用户信息获取成功（缓存）",
     "data": {...}
   }
   ```

2. **数据库查找成功：**

   ```json
   {
     "code": 200,
     "message": "用户信息获取成功",
     "data": {
       "username": "...",
       "email": "...",
       "career": "...",
       "birth_date": "..."
     }
   }
   ```

3. **用户信息不存在：**

   ```json
   {"code": 404, "message": "用户信息不存在"}
   ```

---

###  `update_user_info(request)`（需登录）

* **路径假设为** `/update_user_info/`

1. **成功更新：**

   ```json
   {"code": 200, "message": "用户信息更新成功"}
   ```

2. **找不到用户：**

   ```json
   {"code": 404, "message": "用户信息不存在"}
   ```

3. **其他错误：**

   ```json
   {"code": 400, "message": "错误信息"}
   ```

---

###  `upload_file(request)`（需登录）

* **路径假设为** `/upload_file/`

1. **未上传文件：**

   ```text
   No file uploaded
   ```

   （状态码 400）

2. **上传或替换成功：**

   ```text
   File uploaded successfully
   ```

---

###  `download_file(request)`（需登录）

* **路径假设为** `/download_file/`

1. **文件存在，允许下载：**

   * 返回文件流，带有：

     ```
     Content-Disposition: attachment; filename="文件名"
     ```

2. **找不到文件：**

   * Django 自动返回 404 页面。

3. **当前用户不是该文件的拥有者：**

   * 返回 403 Forbidden（抛出 `PermissionDenied`）

---



## 10.4 系统测试

### 10.4.1 功能测试

#### 10.4.1.1 前端：

#### 1.日程模块：

**日程添加 测试分析：**

![image-20250428215841324](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428215841324.png)

**日程添加 测试用例：**

![image-20250428215929844](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428215929844.png)

（对于类型相同用例，只展示关键用例的详细内容）：

时间轴添加：

![image-20250428215956804](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428215956804.png)

首页快速添加：

![image-20250428220016132](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428220016132.png)

手动添加日程：（未对标题内容进行规范）

![image-20250428220117141](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428220117141.png)

**日程添加 缺陷提交：**

提交未对标题内容进行规范的缺陷：

![image-20250428220217568](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428220217568.png)

**日程修改 测试分析：**

![image-20250428220239588](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428220239588.png)

**日程修改 测试用例：**

![image-20250428220302931](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428220302931.png)

除测试操作外，测试点与添加相似：

日程修改：

![image-20250428220339498](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428220339498.png)

**日程修改 缺陷：**

缺陷与日程添加重复（标题规范问题），不再重复提交。

**日程删除 测试分析：**

![image-20250428220432229](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428220432229.png)

**日程修改 测试用例：**

![image-20250428220643508](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428220643508.png)

**日程修改 缺陷：**

无

#### **2 待办任务模块：**

**待办任务 测试分析：**

![image-20250428221055401](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428221055401.png)

**待办任务 测试用例：**

![image-20250428221114358](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428221114358.png)

**添加待办：**

![image-20250428221153485](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428221153485.png)

**父任务下增加子任务：**

![image-20250428221212506](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428221212506.png)

**完成后划掉任务：**

![image-20250428221229574](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428221229574.png)

**待办任务 缺陷：**

还是存在与日程模块相同的标题规范问题。

![image-20250428221249412](https://gitee.com/RSLG/typora_picture/raw/master/image-20250428221249412.png)

#### **3.计时器模块**

**计时器任务  测试分析：**

![image-20250607000137036](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607000137036.png)

**计时器任务  测试用例：**

![image-20250607000440036](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607000440036.png)

**计时成功：**

![image-20250607000457181](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607000457181.png)

**计时悬浮窗：**

![image-20250607000512075](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607000512075.png)

**共享计时：（获取计时码错误）：**

![image-20250607000553143](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607000553143.png)

**计时器任务  缺陷：**

计时时间过短时，交互体验问题：

![image-20250607000635039](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607000635039.png)

共享计时错误：

![image-20250607000657649](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607000657649.png)

#### **4.每日回顾模块：**

**每日回顾 测试分析：**

![image-20250607000940898](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607000940898.png)

**每日回顾 测试用例：**

![image-20250607001004425](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001004425.png)

**工作时长：**

![image-20250607001030118](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001030118.png)

**AI 总结：**

![image-20250607001054367](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001054367.png)

**每日回顾 缺陷：**

无

#### **5.系统功能模块：**

**系统功能测试分析：**

![image-20250607001142906](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001142906.png)

**系统功能测试用例：**

![image-20250607001205492](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001205492.png)

“一天从哪里开始”：时间轴时间修改未作限制，设置 24 小时也可显示，添加任务将出现有

24：30（错误时间也能显示）的问题

![image-20250607001236805](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001236805.png)

日期切换：

![image-20250607001253333](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001253333.png)

标签设置：

![image-20250607001311095](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001311095.png)

数据导出：（存储权限有问题）

![image-20250607001329169](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001329169.png)

课表导入：（导入显示出错）

![image-20250607001348545](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001348545.png)

**系统功能缺陷提交：**

时间轴修改问题：

![image-20250607001417236](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001417236.png)

课表导入显示问题：

![image-20250607001435733](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001435733.png)

数据导出的存储权限问题：

![image-20250607001454320](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001454320.png)

#### **6.应用锁模块**

**应用锁 测试分析：**

![image-20250607001752707](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001752707.png)

**应用锁 测试用例：**

![image-20250607001810142](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001810142.png)

应用锁类型冲突测试：（开启多重锁，导致循环进入应用锁无法开锁）

![image-20250607001832619](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001832619.png)

应用锁指纹测试：

![image-20250607001856272](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001856272.png)

应用锁手势测试：（不录入密码直接启动手势锁，导致无法开锁）

![image-20250607001914473](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001914473.png)

**应用锁 缺陷提交：**

1.应用锁同时打开导致进入循环锁问题：

![image-20250607001949456](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607001949456.png)

2.未设置密码，也可直接启用：

![image-20250607002014901](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002014901.png)

#### **7.冲刺模块**

**冲刺模块 测试分析：**

![image-20250607002113161](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002113161.png)

**冲刺模块 测试用例：**

任务同步到冲刺列表：

![image-20250607002140425](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002140425.png)冲刺与任务列表切换测试：

![image-20250607002158549](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002158549.png)

冲刺-普通计时测试：

![image-20250607002215723](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002215723.png)

冲刺-番茄计时测试：

![image-20250607002234207](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002234207.png)

**冲刺模块 缺陷提交：**

无

#### **8.登录注册**

**登陆注册 测试分析：**

![image-20250607002336874](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002336874.png)

**登陆注册 测试用例：**

登录：

![image-20250607002422590](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002422590.png)

测试：

![image-20250607002445234](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002445234.png)

注册成功：

![image-20250607002457880](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002457880.png)

登录成功：

![image-20250607002517070](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002517070.png)

**登录注册 缺陷：**

无

#### **9.每日报告模块**

**每日报告模块 测试分析：**

![image-20250607002609301](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002609301.png)

**每日报告模块 测试用例：**

信息同步显示检查：

![image-20250607002641640](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002641640.png)

报告导出测试：

![image-20250607002652738](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002652738.png)

个性化导出测试：

![image-20250607002703672](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002703672.png)

报告内容修改测试：

![image-20250607002723700](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607002723700.png)**每日报告模块 缺陷提交：**

无


#### 10.4.1.1 后端：
#### 1.用户注册接口：
![register](https://gitee.com/RSLG/typora_picture/raw/master/register.png)

#### 2.请求发送验证码接口：
![captcha](https://gitee.com/RSLG/typora_picture/raw/master/captcha.png)

#### 3.用户登录接口：
![login](https://gitee.com/RSLG/typora_picture/raw/master/login.png)

#### 4.获取用户信息接口：
![get_user_info](https://gitee.com/RSLG/typora_picture/raw/master/get_user_info.png)

#### 5.更新用户信息接口：
![update_user_info](https://gitee.com/RSLG/typora_picture/raw/master/update_user_info.png)

#### 6.上传备份文件接口：
![upload_file](https://gitee.com/RSLG/typora_picture/raw/master/upload_file.png)

#### 7.下载备份文件接口：
![download_file](https://gitee.com/RSLG/typora_picture/raw/master/download_file.png)

#### 8.退出登录接口：
![logout](https://gitee.com/RSLG/typora_picture/raw/master/logout.png)

#### 9.管理后台接口：
![admin](https://gitee.com/RSLG/typora_picture/raw/master/admin.png)

### 10.4.2 性能测试

**性能基准：**

| 场景     | 指标      | 目标值    |
| :------- | :-------- | :-------- |
| 冷启动   | 首屏时间  | < 1s      |
| 计划列表 | 滚动帧率  | > 58fps   |
| 图片加载 | 内存占用  | < 30MB/张 |
| 数据同步 | 100条记录 | < 3s      |
| 后台运行 | 内存增长  | < 5MB/h   |

### 10.4.3 兼容性测试

**测试矩阵：**

| 平台    | 操作系统版本 | 设备型号      | 屏幕尺寸 |
| ------- | ------------ | ------------- | -------- |
| Android | 12 (API 31)  | Pixel 6       | 6.4"     |
| Android | 11 (API 30)  | Samsung S21   | 6.2"     |
| Android | 10 (API 29)  | Huawei P30    | 6.1"     |
| Android | 9 (API 28)   | Xiaomi Mi 9   | 6.39"    |
| iOS     | 16           | iPhone 14 Pro | 6.1"     |
| iOS     | 15           | iPhone 13     | 6.1"     |
| iOS     | 14           | iPhone SE     | 4.7"     |

**自动兼容性测试方案：**

```bash
flutter drive \
  --driver=test_driver/compatibility_test.dart \
  --target=integration_test/app_test.dart \
  --device-id=all_connected
```

### 10.4.4 安全测试

1. 数据存储安全
   - 本地数据库加密验证
   - 登录密码加密
     ![passowrd](https://gitee.com/RSLG/typora_picture/raw/master/passowrd.png)
   - 敏感信息（令牌、密码）存储检查
2. 通信安全
   - HTTP 证书验证
   - 中间人攻击测试
3. 认证授权
   - 令牌刷新机制测试
   - 越权访问测试
4. 代码安全
   - 静态代码分析（Flutter Analyze）
   - 依赖漏洞扫描

## 10.5 移动端专项测试

### 10.5.1 网络环境测试

**网络模拟工具：**

```dart
// 网络状态模拟
enum NetworkCondition {
  perfect, // 0% loss, 0ms jitter
  good,    // 2% loss, 100ms jitter
  average, // 5% loss, 200ms jitter
  poor,    // 10% loss, 500ms jitter
  offline,
}

void simulateNetwork(NetworkCondition condition) {
  switch (condition) {
    case NetworkCondition.perfect:
      setNetworkParameters(0, 0);
      break;
    case NetworkCondition.poor:
      setNetworkParameters(10, 500);
      break;
    case NetworkCondition.offline:
      disconnectNetwork();
      break;
    // ...
  }
}

// 网络测试场景
testNetwork('弱网环境下应正常保存数据', () async {
  simulateNetwork(NetworkCondition.poor);
  
  final result = await savePlan(Plan(title: '弱网测试'));
  expect(result, isTrue);
  
  // 验证数据完整性
  final savedPlan = await localDb.getPlan('plan_123');
  expect(savedPlan.title, '弱网测试');
});
```

### 10.5.2 设备兼容性测试

**自动化设备矩阵测试：**

```yaml
# codemagic.yaml
workflows:
  device-testing:
    name: Device Compatibility Test
    environment:
      flutter: stable
    scripts:
      - flutter pub get
      - flutter test
      - flutter build apk --release
      - flutter build ios --release --no-codesign
    artifacts:
      - build/**/outputs/**/*.apk
      - build/**/outputs/**/*.ipa
    publishing:
      email:
        recipients:
          - team@example.com
    device:
      android:
        - model: pixel5
          version: 31
        - model: galaxy_s10
          version: 29
      ios:
        - model: iphone13
          version: latest
        - model: ipad_mini
          version: '15.0'
```



### 10.5.3 电量与内存测试

**测试指标：**

| 场景         | 指标          | 可接受阈值 |
| :----------- | :------------ | :--------- |
| 前台正常使用 | 电量消耗/小时 | < 15%/h    |
| 后台位置跟踪 | 电量消耗/小时 | < 8%/h     |
| 内存峰值     | 高端设备      | < 300MB    |
| 内存峰值     | 低端设备      | < 150MB    |
| 内存泄漏     | 24小时运行    | < 5MB增长  |
| 后台服务     | 内存占用      | < 50MB     |

## 10.6 测试部署与CI/CD
**前端**
**自动化安装和验证环境：**

**Flutter 安装**：自动安装指定版本的 Flutter SDK，并验证其版本。确保了开发环境的稳

定性；**依赖安装**：flutter pub get 自动安装项目所需的依赖，避免手动操作漏掉依赖包的情

况，提升项目构建的稳定性。

![image-20250607003752692](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607003752692.png)

**代码格式化一致性：**

使用 dart format . 进行自动格式化，确保团队中每个开发者提交的代码格式一致，提

高代码的可读性和一致性。

![image-20250607003811057](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607003811057.png)

**确保代码质量：**

自动检查代码中的潜在问题，如过时的 API、未使用的导入、潜在的错误和编码风格问

题。保障我们的代码质量：

1. 指出使用了已弃用的 API

![image-20250607003831253](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607003831253.png)

显示使用了 withOpacity 方法，这是一个已弃用的 API，建议你使用 .withValues() 代

替

![image-20250607003855783](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607003855783.png)

MaterialState 已弃用，建议使用 WidgetState

MaterialStateBorderSide 已弃用，建议使用 WidgetStateBorderSide

2. 指出未定义的标识符 Env：（env.g.dart 文件没有提交到项目仓库）

![image-20250607003942900](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607003942900.png)

显示多个地方出现了 Env 未定义的错误

3. 冗余导入提醒

![image-20250607004100141](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607004100141.png)

**持续集成与代码检查：**

每次推送到 main 分支或创建 Pull Request 时，都会自动执行确保每次合并到主分支

的代码都经过严格的代码检查和依赖安装，确保主分支代码的质量：

![image-20250607004113914](https://gitee.com/RSLG/typora_picture/raw/master/image-20250607004113914.png)

**Django 后端使用 GitHub Actions 实现 CI/CD ：**
在根目录下新建文件夹.github/workflows,创建django-tests.yml文件进行测试

![1](https://gitee.com/RSLG/typora_picture/raw/master/1.png)

![2](https://gitee.com/RSLG/typora_picture/raw/master/2.png)

![3](https://gitee.com/RSLG/typora_picture/raw/master/3.png)

![4](https://gitee.com/RSLG/typora_picture/raw/master/4.png)

![5](https://gitee.com/RSLG/typora_picture/raw/master/5.png)

![7](https://gitee.com/RSLG/typora_picture/raw/master/7.png)

![8](https://gitee.com/RSLG/typora_picture/raw/master/8.png)

![9](https://gitee.com/RSLG/typora_picture/raw/master/9.png)



# 十三、性能优化 [龚嘉瑶、王五]

## 13.1 前端性能优化

### 13.1.1 页面加载优化

#### 1. 预加载与懒加载策略

```dart
// main.dart - 预加载关键资源
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // 预加载关键资源
  await Future.wait([
    precacheImage(AssetImage('assets/splash_bg.jpg'), context),
    DefaultAssetBundle.of(context).load('assets/critical_data.json'),
    Hive.initFlutter(), // 初始化本地存储
  ]);
  
  runApp(MyApp());
}

// 计划列表页 - 懒加载非关键内容
ListView.builder(
  itemCount: plans.length,
  itemBuilder: (context, index) {
    // 延迟加载图片
    return LazyLoadImage(
      image: NetworkImage(plans[index].imageUrl),
      placeholder: ShimmerPlaceholder(),
      child: PlanItem(plan: plans[index]),
    );
  },
);
```

#### 2. 启动优化技术

```dart
// 轻量级启动页
class SplashScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return FutureBuilder(
      future: _initializeApp(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.done) {
          return MainApp();
        }
        return Scaffold(
          body: Center(child: FlutterLogo(size: 100)),
        );
      },
    );
  }

  Future<void> _initializeApp() async {
    await Future.wait([
      // 并行初始化关键服务
      AuthService.init(),
      NotificationService.init(),
      // 延迟加载非关键服务
      Future.delayed(Duration(seconds: 1), 
    ]);
  }
}
```

#### 3. 路由优化

```dart
// 使用路由预编译
MaterialApp(
  onGenerateRoute: (settings) {
    // 预编译热门路由
    if (settings.name == '/plan/detail') {
      return PageRouteBuilder(
        pageBuilder: (_, __, ___) => PlanDetailPage(
          planId: settings.arguments as String,
        ),
        transitionsBuilder: (_, a, __, c) => 
            FadeTransition(opacity: a, child: c),
      );
    }
    return null;
  },
);

// 路由懒加载
Route<dynamic> generateRoute(RouteSettings settings) {
  switch (settings.name) {
    case '/statistics':
      return MaterialPageRoute(
        builder: (_) => FutureBuilder(
          future: import('pages/statistics.dart'),
          builder: (_, snapshot) => 
              snapshot.hasData ? StatisticsPage() : LoadingPage(),
        ),
      );
  }
}
```

### 13.1.2 资源优化

#### 1. 图像资源优化

```dart
// 图像组件优化
CachedNetworkImage(
  imageUrl: plan.thumbnailUrl,
  memCacheWidth: (MediaQuery.of(context).size.width * 2).toInt(),
  maxHeightDiskCache: 1080,
  placeholder: (_, __) => ColorPlaceholder(
    color: plan.dominantColor,
  ),
  errorWidget: (_, __, ___) => Icon(Icons.error),
);

// SVG 替代方案
SvgPicture.asset(
  'assets/icons/location.svg',
  width: 24,
  height: 24,
  colorFilter: ColorFilter.mode(
    Theme.of(context).primaryColor, 
    BlendMode.srcIn
  ),
);

// 资源分包加载
void loadAssets() async {
  // 核心资源
  await rootBundle.load('assets/core.zip');
  
  // 延迟加载非核心资源
  Timer(Duration(seconds: 5), () async {
    await rootBundle.load('assets/additional.zip');
  });
}
```

#### 2. 代码与数据优化

```dart
// 按需加载语言包
class LazyLocalizations extends LocalizationsDelegate<AppLocalizations> {
  @override
  Future<AppLocalizations> load(Locale locale) async {
    final data = await rootBundle.loadString(
      'assets/locales/${locale.languageCode}.json',
    );
    return AppLocalizations(locale, json.decode(data));
  }
}

// 数据压缩与缓存
class ApiService {
  static Future<Map<String, dynamic>> fetchData(String endpoint) async {
    final response = await dio.get(
      endpoint,
      options: Options(
        headers: {'Accept-Encoding': 'gzip, deflate'},
      ),
    );
    
    // 缓存响应
    cacheManager.put(endpoint, response.data);
    return response.data;
  }
}
```

### 13.1.3 渲染性能优化

#### 1. 构建优化技术

```dart
// 使用 const 构造函数
class PlanItem extends StatelessWidget {
  const PlanItem({super.key, required this.plan});
  
  @override
  Widget build(BuildContext context) {
    return const Padding(
      padding: EdgeInsets.symmetric(vertical: 8),
      child: _PlanContent(),
    );
  }
}

// 避免重建
class _PlanDetailState extends State<PlanDetail> {
  final _titleController = TextEditingController();
  
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        ValueListenableBuilder(
          valueListenable: _titleController,
          builder: (_, value, __) => Text(value.text),
        ),
        TextField(
          controller: _titleController,
        ),
        // 使用Key防止不必要重建
        HeavyWidget(key: ValueKey(plan.id)),
      ],
    );
  }
}
```

#### 2. 列表渲染优化

```dart
ListView.builder(
  itemCount: 10000,
  itemBuilder: (context, index) {
    return AutoCacheItem(
      index: index,
      builder: (context) => PlanItem(plan: plans[index]),
    );
  },
  // 优化滚动性能
  addAutomaticKeepAlives: false,
  addRepaintBoundaries: true,
);

// 自定义滑动列表
class OptimizedListView extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scrollable(
      viewportBuilder: (context, offset) {
        return Viewport(
          offset: offset,
          slivers: [
            SliverList(
              delegate: SliverChildBuilderDelegate(
                (context, index) => PlanItem(plan: plans[index]),
                childCount: plans.length,
                // 优化查找算法
                findChildIndexCallback: (key) {
                  final valueKey = key as ValueKey<String>;
                  return plans.indexWhere((p) => p.id == valueKey.value);
                },
              ),
            ),
          ],
        );
      },
    );
  }
}
```

#### 3. 动画与GPU优化

```dart
// 高性能动画
class AnimatedPlanCard extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return TweenAnimationBuilder(
      tween: Tween(begin: 0.0, end: 1.0),
      duration: Duration(milliseconds: 300),
      builder: (context, value, child) {
        return Opacity(
          opacity: value,
          child: Transform.scale(
            scale: value,
            child: child,
          ),
        );
      },
      child: PlanCard(),
    );
  }
}

// GPU优化技巧
ShaderMask(
  blendMode: BlendMode.srcATop,
  shaderCallback: (rect) {
    return LinearGradient(
      colors: [Colors.blue, Colors.transparent],
    ).createShader(rect);
  },
  child: HeavyVisualElement(),
);
```



## 13.2 后端性能优化

### 13.2.1 数据库优化
| 优化点         | 描述                                                                        |
| ----------- | ------------------------------------------------------------------------- |
| **数据库设计简洁** | 使用 `UserFile` 模型，将文件与用户一一关联，结构清晰、查询高效。                                    |
| **权限控制合理**  | 上传和下载操作均通过 `request.user` 鉴权，防止未登录和越权操作。                                  |
| **查询优化**    | 下载文件使用 `get_object_or_404(UserFile, user_id=request.user.id)`，直接使用索引字段定位。 |
| **异常处理健全**  | 处理了 `UserFile.DoesNotExist` 异常，避免无效数据库访问导致程序崩溃。                           |

### 13.2.2 缓存策略
###  1. **提升性能，减轻数据库压力**

#### 代码位置：

```python
def get_user_info(request):
    ...
    cached_data = cache.get(key)
    if cached_data:
        print("从缓存中读取用户信息")
        return JsonResponse({...})
```

#### 说明：

* 用户信息第一次从数据库读取并缓存，后续请求命中缓存后直接返回，避免频繁访问数据库。
* **优势**：提高响应速度，降低数据库负载，尤其在高并发环境下表现尤为明显。

---

###  2. **避免重复操作，提高系统效率**

#### 代码位置：

```python
def send_email_captcha(request):
    ...
    if cache.get(cache_key):
        return JsonResponse({"code": 429, "message": "请勿频繁请求验证码"})
```

#### 说明：

* 通过设置 Redis 缓存防止在短时间内重复发送验证码。
* **优势**：提升用户体验的同时，避免滥发邮件带来的资源浪费和系统压力。

---

###  3. **提高登录验证效率**

#### 代码位置：

```python
def login_view(request):
    ...
    cache.set(f"is_logged_in:{user.id}", True, timeout=2 * 60 * 60)
    cache.set(f"login_time:{user.id}", now().isoformat())
```

#### 说明：

* 登录后将状态和时间记录在缓存中，便于快速验证用户状态和后续日志分析。
* **优势**：比从数据库中频繁查询状态字段更加高效，利于扩展如防止多地同时登录等功能。

---

###  4. **确保验证码的时效性与唯一性**

#### 代码位置：

```python
def register(request):
    ...
    real_captcha = cache.get(cache_key)
    ...
    cache.delete(cache_key)
```

#### 说明：

* 验证码存入缓存，5分钟内有效，验证后立刻删除，防止复用。
* **优势**：保证验证码的唯一性与安全性，同时不需要写入数据库，操作轻便。

---

###  5. **缓存失效机制简化数据一致性处理**

#### 代码位置：

```python
def update_user_info(request):
    ...
    cache.delete(f"user_profile:{user.id}")
```

#### 说明：

* 用户更新信息后手动清除缓存，保证下一次访问会重新从数据库读取新数据。
* **优势**：减少数据不同步的风险，代码逻辑简单，数据一致性有保障。

---

## 使用缓存的优点一览

| 优点               | 说明                          |
| ---------------- | --------------------------- |
| 提升访问速度           | 避免重复查询数据库，尤其是频繁访问的数据（如用户信息） |
| 减轻数据库负载          | 特别适用于高并发下的读操作，如登录状态、验证码校验等  |
| 实现接口频控与安全防护      | 如验证码发送频率限制、验证码唯一性与有效期       |
| 简化业务逻辑中的状态存储与检查  | 登录状态与时间、用户是否在线等通过缓存判断       |
| 有效配合数据更新后的缓存失效策略 | 更新数据后清除缓存，确保读取的是最新数据        |


### 13.2.3 并发处理优化
1. **Celery 配置**

   * `Element_Plan/celery.py` 和 `__init__.py` 初始化 Celery 实例。
   * 在 `settings.py` 中添加 Redis 为 broker 和 backend。
2. **异步任务封装**

   * 在 `user/tasks.py` 中将邮件发送任务封装为 `send_register_email_task`。
    ```python
    @shared_task
    def send_register_email_task(email, captcha):
        send_mail(
            subject="元素时间注册验证码",
            message=f"您的注册验证码是：{captcha}",
            recipient_list=[email],
            from_email=None,
        )
   
    ```
3. **视图异步处理**

   * 注册验证码发送视图 `send_email_captcha` 使用 `delay()` 异步调用 Celery 任务。
    ```python
    send_register_email_task.delay(email, captcha)
   
    ```
   * 用户信息查询视图 `get_user_info` 使用 `async/await` 和 `sync_to_async` 实现异步缓存和数据库访问。
   ```python
    @login_required
    @csrf_exempt
    @require_http_methods(['GET'])
    async def get_user_info(request):
        key = f"user_profile:{request.user.id}"
        cached_data = await sync_to_async(cache.get)(key)
   
        if cached_data:
            return JsonResponse({'code': 200, 'message': '用户信息获取成功（缓存）', 'data': cached_data})
    
        try:
            user_profile = await sync_to_async(UserProfile.objects.get)(user=request.user)
            user_info = {
                'username': user_profile.user.username,
                'email': user_profile.user.email,
                'career': user_profile.career,
                'birth_date': user_profile.birth_date,
            }
            await sync_to_async(cache.set)(key, user_info, timeout=300)
            return JsonResponse({'code': 200, 'message': '用户信息获取成功', 'data': user_info})
        except UserProfile.DoesNotExist:
            return JsonResponse({'code': 404, 'message': '用户信息不存在'}, status=404)
   
   ```


## 13.3 网络优化
| 优化点                | 描述                                                            |
| ------------------ | ------------------------------------------------------------- |
| **文件下载优化**         | `Content-Disposition` 设置为 `attachment`，支持浏览器端直接下载，提高用户体验。     |
| **HTTP安全性**        | 使用了 Django 登录系统和 `@login_required`，防止未授权访问，提升系统安全性。           |
| **CSRF豁免配置（特定下载）** | 在 `download_file` 函数中使用了 `@csrf_exempt`，避免 CSRF 校验对 GET 请求误拦。 |


### 13.3.1 数据压缩
   gzip 可以将文本类数据（如 HTML、CSS、JavaScript、JSON 等）压缩成更小的体积，通常能压缩到原始大小的 20%～30%左右，从而显著减少数据在网络中的传输量。由于压缩后数据体积更小，网络传输时间减少，网页或API响应加载速度加快，用户体验得到提升，尤其是在带宽受限或网络延迟较高的环境下效果更明显。通过减少传输数据量，服务器的带宽使用压力减轻。HTTP 通过 `Accept-Encoding` 请求头告知服务器支持的压缩格式，服务器通过 `Content-Encoding` 响应头返回压缩后的内容，实现透明的压缩传输。

---
![gzip](https://gitee.com/RSLG/typora_picture/raw/master/gzip.png)
